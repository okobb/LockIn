name: CD - Deploy

on:
  workflow_run:
    workflows: ["CI - Build and Push"]
    types:
      - completed
    branches: [main]

env:
  DOCKERHUB_USERNAME: okobb

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKERHUB_USERNAME: ${{ env.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        with:
          host: ${{ secrets.HOST_NAME }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          envs: DOCKERHUB_USERNAME,DOCKERHUB_TOKEN
          script: |
            cd /var/www/LockIn

            git fetch origin main
            git reset --hard origin/main

            echo "${DOCKERHUB_TOKEN}" | sudo docker login -u ${DOCKERHUB_USERNAME} --password-stdin

            sudo docker system prune -a -f

            sudo docker compose pull
            sudo docker compose up -d --remove-orphans

            echo "Waiting for services to start..."
            sleep 15

            sudo docker compose exec -T laravel php artisan migrate --force
            sudo docker compose exec -T laravel php artisan config:cache || true
            sudo docker compose exec -T laravel php artisan route:cache || true

            echo "Running health checks..."
            curl -sf http://localhost/api/health > /dev/null && echo "✓ Laravel API is healthy" || echo "✗ Laravel API check failed"

            echo "Deployment complete!"
